var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var addPlugin=function addPlugin(config,systemRequirements,pluginFunctions){return Object.assign({config:config,systemRequirements:systemRequirements},pluginFunctions);};var addCommand=function addCommand(sentenceMemberRequirements,execute){return{sentenceMemberRequirements:sentenceMemberRequirements,execute:execute};};var FacebookApi=require("./facebook.api");var options={};var api=new FacebookApi(options);var lastMessages='';module.exports=addPlugin({facebook:{login:'',password:'',automatic:{checkNewMessage:false}}},{os:{linux:true,darwin:true,win32:true,android:true,ios:true},pluginFormatVersion:1},{scriptStart:function(){var _scriptStart=(0,_asyncToGenerator2.default)(function*(config,services){options.tab=yield services.browserPluginStart('https://facebook.com/messages/t');});function scriptStart(_x,_x2){return _scriptStart.apply(this,arguments);}return scriptStart;}(),scriptDestructor:function(){var _scriptDestructor=(0,_asyncToGenerator2.default)(function*(config,services){yield api.logout();options.tab.destructor();});function scriptDestructor(_x3,_x4){return _scriptDestructor.apply(this,arguments);}return scriptDestructor;}(),scriptPerInterval:function(){var _scriptPerInterval=(0,_asyncToGenerator2.default)(function*(config,services){if(!config.facebook.automatic.checkNewMessage)return;yield options.tab.pause.start();try{yield api.login(config);var newMessages=yield api.getMessages(false,true);var friends=Object.keys(newMessages);var newMessagesString=JSON.stringify(newMessages);if(lastMessages!==newMessagesString){lastMessages=newMessagesString;if(friends.length>1)yield services.speech('Máš nové správy od priateľov '+friends.join(', ').replace(/, ([^,]+)$/,' a $1'));if(friends.length===1)yield services.speech('Máš novú správu od priateľa '+friends[0]);}}catch(err){throw err;}finally{options.tab.pause.stop();}});function scriptPerInterval(_x5,_x6){return _scriptPerInterval.apply(this,arguments);}return scriptPerInterval;}(),commands:[function(config,services){return{sentenceMemberRequirements:{_or:[{type:'question',predicates:{multiple:[{verbs:[{baseWord:/(na|od)písať/}]}]},objects:[{multiple:[{origWord:/niekto/}]}]},{type:'question',predicates:{multiple:[{verbs:[{baseWord:/mať|prísť/}]}]},objects:[{multiple:[{baseWord:/správa/}]}]}]},execute:function(){var _execute=(0,_asyncToGenerator2.default)(function*(getSummaryAccept,propName){yield options.tab.pause.start();try{yield services.speech('Pozriem...');yield options.tab.viewTab();yield api.login(config);var friends=Object.keys(yield api.getMessages(false));if(friends.length>1)yield services.speech('Máš nové správy od priateľov '+friends.join(', ').replace(/, ([^,]+)$/,' a $1'));if(friends.length===1)yield services.speech('Máš novú správu od priateľa '+friends[0]);if(friends.length===0)yield services.speech('Nemáš žiadne nové správy');}catch(err){throw err;}finally{options.tab.pause.stop();}});function execute(_x7,_x8){return _execute.apply(this,arguments);}return execute;}()};},function(config,services){return{sentenceMemberRequirements:{_or:[{type:'command',predicates:{multiple:[{verbs:[{baseWord:/prečítať/}]}]},objects:[{multiple:[{origWord:/správy|ich/}]}]}]},execute:function(){var _execute2=(0,_asyncToGenerator2.default)(function*(getSummaryAccept,propName){yield options.tab.pause.start();try{yield services.speech('Okamih...');yield options.tab.viewTab();yield api.login(config);var messages=yield api.getMessages(true);yield services.speech(Object.keys(messages).map(function(name){return`${name} píše, ${messages[name].join(' ')},`;}).join(' '));if(Object.keys(messages).length===0)yield services.speech('Nemáš žiadne nové správy');}catch(err){throw err;}finally{options.tab.pause.stop();}});function execute(_x9,_x10){return _execute2.apply(this,arguments);}return execute;}()};},function(config,services){return{sentenceMemberRequirements:{type:'question',predicates:{multiple:[{verbs:[{baseWord:[/(na|od)?písať/]}]}]},subjects:{multiple:[{propName:{friend:'required'}}]},objects:[{multiple:[{origWord:/čo/}]}]},execute:function(){var _execute3=(0,_asyncToGenerator2.default)(function*(getSummaryAccept,propName){yield options.tab.pause.start();try{yield services.speech('Pozriem...');yield options.tab.viewTab();yield api.login(config);var name=propName.friend.baseWord;var messages=yield api.getMessages(name);if(!Object.keys(messages).length)yield services.speech(`${name} ti nenapísal žiadnu novú správu.`);else yield services.speech(Object.keys(messages).map(function(name){return`${name} píše, ${messages[name].join(' ')},`;}).join(' '));}catch(err){throw err;}finally{options.tab.pause.stop();}});function execute(_x11,_x12){return _execute3.apply(this,arguments);}return execute;}()};},function(config,services){return{sentenceMemberRequirements:{type:'command',predicates:{multiple:[{verbs:[{baseWord:[/(na|od)?písať/,/(od|p)oslať/]}]}]},objects:[{multiple:[{baseWord:'správa'}]},{multiple:[{_or:[{case:{value:'datív'},propName:{friend:'required'}},{preposition:{origWord:'pre'},propName:{friend:'required'}}]}]}]},execute:function(){var _execute4=(0,_asyncToGenerator2.default)(function*(getSummaryAccept,propName){yield options.tab.pause.start();try{yield options.tab.viewTab();yield api.login(config);if(!propName.citation){var _yield$services$speec=yield services.speech('Môžeš diktovať',true),text=_yield$services$speec.text;propName.citation=text;}else yield services.speech('OK');var fiends=propName.friend.parent.multiple.map(function(f){return f.baseWord;});var preFriends=propName.friend.parent.multiple.filter(function(w){return w.preposition.origWord=='pre';}).map(function(f){return f.baseWord;});if(preFriends.length)fiends=preFriends;var realNames=yield api.sendMessage(fiends,'');var unfindedNames=fiends.filter(function(n){return!realNames[n];});if(unfindedNames.length){yield services.speech((unfindedNames.length>1?'Mená':'Meno')+unfindedNames.join(' a ')+' som v blízkych kontaktoch nenašiel.');}else if(yield getSummaryAccept('FacebookChat plugin: Poslať správu '+(Object.values(realNames).length===1?'priateľovi: ':'priateľom: ')+Object.values(realNames).join(', ')+' s textom: '+propName.citation)){yield api.sendMessage(fiends,propName.citation);yield services.speech('Odoslané...');}}catch(err){throw err;}finally{options.tab.pause.stop();}});function execute(_x13,_x14){return _execute4.apply(this,arguments);}return execute;}()};}]});